{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="section-content padding-y bg">
  <div class="container">

    <div class="card">
      <div class="row no-gutters">

        <!-- Product Image -->
        <aside class="col-md-6">
          <article class="gallery-wrap"> 
            <div class="img-big-wrap">
              <a href="#"><img src="{{ product.images.url }}" alt="{{ product.product_name }}"></a>
            </div>
          </article>
        </aside>

        <!-- Product Information -->
        <main class="col-md-6 border-left">
          <article class="content-body">

            <h2 class="title">{{ product.product_name }}</h2>

            <div class="mb-3"> 
              <var class="price h4">${{ product.price }}</var> 
            </div> 

            <p>{{ product.description }}</p>
            <p><small class="text-muted">–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: {{ product.created_date|date:"d.m.Y" }}</small></p>

            <hr>

            <!-- Stock Status & Add to Cart -->
            {% if product.stock <= 0 %}
                <h5 class="text-danger">–†–∞—Å–ø—Ä–æ–¥–∞–Ω–æ</h5>
            {% else %}
                <a href="{% url 'add_cart' product.id %}" class="btn btn-primary w-100 mb-2">
                    <span class="text">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</span> 
                    <i class="fas fa-shopping-cart"></i>
                </a>
            {% endif %}

            <!-- Wishlist Button (always show) -->
            <a href="{% url 'add_to_wishlist' product.id %}" class="btn btn-outline-secondary w-100">
                <i class="fa fa-heart me-2"></i> –í —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–µ–º–æ–≥–æ
            </a>

          </article>
        </main>
      </div>
    </div>

    <br>
    
    <!-- ‚≠êÔ∏è RATING Section -->
<!-- ‚≠êÔ∏è Rating Section -->
<div class="row">
  <div class="col-md-9">

    <!-- Average Rating -->
    <header class="section-heading mb-4">
      <h3 class="mb-3">‚≠êÔ∏è –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</h3>
    </header>

    {% if avg_rating %}
      <p class="h5 mb-4">{{ avg_rating|floatformat:1 }} ‚≠êÔ∏è –Ω–∞ –æ—Å–Ω–æ–≤–µ {{ product.ratings.count }} –æ—Ü–µ–Ω–æ–∫</p>
    {% else %}
      <p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫.</p>
    {% endif %}

    <!-- Add/Update Rating -->
    <h5 class="mb-3">–í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞:</h5>

    {% if user.is_authenticated %}
      {% if user_rating %}
        <p class="mb-2">–í—ã —É–∂–µ –ø–æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ü–µ–Ω–∫—É: <strong>{{ user_rating.rating }} ‚≠êÔ∏è</strong> ({{ user_rating.created_at|date:"d.m.Y" }})</p>
      {% endif %}

      <form method="post" action="{% url 'add_rating' product.id %}" class="mb-4">
        {% csrf_token %}
        <div class="input-group w-auto mb-2">
          <select name="rating" class="form-select" required>
            <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ --</option>
            {% for i in rating_range %}
              <option value="{{ i }}" {% if user_rating and user_rating.rating == i %}selected{% endif %}>{{ i }} ‚≠êÔ∏è</option>
            {% endfor %}
          </select>
          <button type="submit" class="btn btn-primary">
            {% if user_rating %}–û–±–Ω–æ–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É{% else %}–ü–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É{% endif %}
          </button>
        </div>
      </form>

    {% else %}
      <p><a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É.</p>
    {% endif %}

    <hr class="my-5">

    <!-- üìù Reviews Section -->
    <h3 class="mb-4">–û—Ç–∑—ã–≤—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π</h3>

    <!-- Add Review Form -->
    {% if user.is_authenticated %}
      <form method="post" action="{% url 'add_review' product.id %}" class="mb-5">
        {% csrf_token %}
        <div class="mb-3">
          <textarea name="comment" class="form-control" rows="3" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤..." required></textarea>
        </div>
        <button type="submit" class="btn btn-secondary">–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
      </form>
    {% else %}
      <p><a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤.</p>
    {% endif %}

    <!-- Existing Reviews -->
    {% for review in product.reviews.all %}
      <article class="box border p-4 rounded mb-4 bg-light">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong>{{ review.user.get_full_name|default:review.user.email }}</strong>
          <span class="text-muted small">{{ review.created_at|date:"d.m.Y" }}</span>
        </div>
        <p class="mb-0">{{ review.comment }}</p>
      </article>
    {% empty %}
      <p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.</p>
    {% endfor %}



      </div>
    </div>

  </div>
</section>
{% endblock %}
